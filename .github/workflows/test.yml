name: Test

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - run: go test -v ./... -run "TestDecode|TestParseJSONB"

  # Linux integration tests with Docker
  integration-linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pg: ['12', '13', '14', '15', '16', '17']
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build binary
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o pgdump-offline .

      - name: Start PostgreSQL ${{ matrix.pg }}
        run: |
          docker run -d --name pg \
            -e POSTGRES_PASSWORD=testpass \
            -e POSTGRES_DB=testdb \
            postgres:${{ matrix.pg }}
          
          # Wait for PostgreSQL to be ready
          for i in {1..30}; do
            docker exec pg pg_isready -U postgres && break
            sleep 1
          done

      - name: Create test data
        run: |
          # Ensure testdb exists
          docker exec pg psql -U postgres -c "CREATE DATABASE testdb;" || true
          
          # Create tables
          docker exec pg psql -U postgres -d testdb -c "CREATE TABLE users (id SERIAL PRIMARY KEY, email VARCHAR(255), password_hash VARCHAR(255), is_admin BOOLEAN DEFAULT false);"
          docker exec pg psql -U postgres -d testdb -c "INSERT INTO users (email, password_hash, is_admin) VALUES ('admin@test.com', '\$argon2id\$v=19\$m=4096,t=3,p=1\$salt\$hash', true);"
          docker exec pg psql -U postgres -d testdb -c "INSERT INTO users (email, password_hash, is_admin) VALUES ('user1@test.com', '\$argon2id\$v=19\$m=4096,t=3,p=1\$salt\$hash2', false);"
          docker exec pg psql -U postgres -d testdb -c "INSERT INTO users (email, password_hash, is_admin) VALUES ('user2@test.com', '\$argon2id\$v=19\$m=4096,t=3,p=1\$salt\$hash3', false);"
          
          docker exec pg psql -U postgres -d testdb -c "CREATE TABLE secrets (id SERIAL PRIMARY KEY, name VARCHAR(255), value JSONB);"
          docker exec pg psql -U postgres -d testdb -c "INSERT INTO secrets (name, value) VALUES ('aws_credentials', '{\"access_key\": \"AKIAIOSFODNN7EXAMPLE\", \"secret_key\": \"wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY\"}');"
          docker exec pg psql -U postgres -d testdb -c "INSERT INTO secrets (name, value) VALUES ('database_url', '{\"host\": \"db.internal\", \"port\": 5432, \"password\": \"supersecret123\"}');"
          
          # Verify tables were created
          docker exec pg psql -U postgres -d testdb -c "\dt"
          
          # Checkpoint and stop to flush
          docker exec pg psql -U postgres -c "CHECKPOINT;"
          docker stop pg
          sleep 2
          docker start pg
          
          # Wait for ready
          for i in {1..30}; do
            docker exec pg pg_isready -U postgres && break
            sleep 1
          done

      - name: Copy binary to container
        run: docker cp pgdump-offline pg:/usr/local/bin/

      - name: Debug PostgreSQL
        run: |
          echo "=== PostgreSQL data directory ==="
          docker exec pg ls -la /var/lib/postgresql/data/
          docker exec pg ls -la /var/lib/postgresql/data/global/ | head -10
          docker exec pg ls -la /var/lib/postgresql/data/base/
          
          echo "=== PostgreSQL version ==="
          docker exec pg psql -U postgres -c "SELECT version();"
          
          echo "=== Databases ==="
          docker exec pg psql -U postgres -c "SELECT oid, datname FROM pg_database;"

      - name: Verify testdb exists in pg_database
        run: |
          echo "=== Databases in pg_database file ==="
          docker exec pg pgdump-offline -d /var/lib/postgresql/data/ -list-db
          
          echo "=== Verify testdb is present ==="
          docker exec pg pgdump-offline -d /var/lib/postgresql/data/ -list-db | grep -q testdb || {
            echo "ERROR: testdb not found in pg_database!"
            echo "=== Raw pg_database file ==="
            docker exec pg xxd /var/lib/postgresql/data/global/1262 | head -100
            exit 1
          }
          echo "testdb found!"

      - name: Debug and Test
        run: |
          echo "=== 1. Tables in testdb via psql ==="
          docker exec pg psql -U postgres -d testdb -c "\dt"
          
          echo "=== 2. Get testdb OID ==="
          TESTDB_OID=$(docker exec pg psql -U postgres -tAc "SELECT oid FROM pg_database WHERE datname='testdb'")
          echo "testdb OID: $TESTDB_OID"
          
          echo "=== 3. List files in testdb directory ==="
          docker exec pg ls -la /var/lib/postgresql/data/base/$TESTDB_OID/ | head -20
          
          echo "=== 4. Parse pg_class directly ==="
          docker exec pg pgdump-offline -f /var/lib/postgresql/data/base/$TESTDB_OID/1259 2>&1 | grep -E "(users|secrets|Table:)" | head -20
          
          echo "=== 5. Full dump of testdb ==="
          docker exec pg pgdump-offline -d /var/lib/postgresql/data/ -db testdb 2>&1 | head -100
          
          echo "=== 6. Verify tables exist ==="
          docker exec pg pgdump-offline -d /var/lib/postgresql/data/ -db testdb | jq '.databases[0].tables[]?.name' | head -20

      - name: Cleanup
        if: always()
        run: docker rm -f pg || true

  # macOS integration test
  integration-macos:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        pg: ['12', '13', '14', '15', '16', '17']
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install PostgreSQL ${{ matrix.pg }}
        run: |
          brew install postgresql@${{ matrix.pg }}
          brew services start postgresql@${{ matrix.pg }}
          sleep 5
          
          # Find the right path
          if [ -d /opt/homebrew/opt/postgresql@${{ matrix.pg }} ]; then
            PG_PATH=/opt/homebrew/opt/postgresql@${{ matrix.pg }}/bin
          else
            PG_PATH=/usr/local/opt/postgresql@${{ matrix.pg }}/bin
          fi
          echo "PG_PATH=$PG_PATH" >> $GITHUB_ENV
          
          # Create test database
          $PG_PATH/createdb -h localhost testdb

      - name: Create test data
        run: |
          $PG_PATH/psql -h localhost -c "CREATE TABLE users (id SERIAL, email VARCHAR(255), password_hash VARCHAR(255));" testdb
          $PG_PATH/psql -h localhost -c "INSERT INTO users (email, password_hash) VALUES ('admin@test.com', '\$argon2id\$hash');" testdb
          $PG_PATH/psql -h localhost -c "CREATE TABLE secrets (id SERIAL, name VARCHAR(255), value JSONB);" testdb
          $PG_PATH/psql -h localhost -c "INSERT INTO secrets (name, value) VALUES ('aws', '{\"key\": \"AKIA...\"}');" testdb
          $PG_PATH/psql -h localhost -c "CHECKPOINT;" testdb

      - name: Build
        run: go build -o pgdump-offline .

      - name: Test auto-detection
        run: |
          echo "=== Testing -detect ==="
          ./pgdump-offline -detect
          
          echo "=== Testing -list-db ==="
          ./pgdump-offline -list-db
          
          echo "=== Testing dump ==="
          ./pgdump-offline -db testdb -t users | jq .

  # Windows integration test  
  integration-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        pg: ['12', '13', '14', '15', '16', '17']
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install PostgreSQL ${{ matrix.pg }}
        shell: pwsh
        run: |
          choco install postgresql${{ matrix.pg }} --params '/Password:testpass' -y
          refreshenv
          Start-Sleep -Seconds 10
          
          $env:PATH = "C:\Program Files\PostgreSQL\${{ matrix.pg }}\bin;$env:PATH"
          echo "PG_PATH=C:\Program Files\PostgreSQL\${{ matrix.pg }}\bin" >> $env:GITHUB_ENV

      - name: Create test data
        shell: pwsh
        run: |
          $env:PGPASSWORD = "testpass"
          $env:PATH = "$env:PG_PATH;$env:PATH"
          
          & psql -U postgres -c "CREATE DATABASE testdb;"
          & psql -U postgres -d testdb -c "CREATE TABLE users (id SERIAL, email VARCHAR(255), password_hash VARCHAR(255));"
          & psql -U postgres -d testdb -c "INSERT INTO users (email, password_hash) VALUES ('admin@test.com', '\$argon2id\$hash');"
          & psql -U postgres -d testdb -c "CREATE TABLE secrets (id SERIAL, name VARCHAR(255), value JSONB);"
          & psql -U postgres -d testdb -c "INSERT INTO secrets (name, value) VALUES ('aws', '{\"key\": \"AKIA...\"}');"
          & psql -U postgres -d testdb -c "CHECKPOINT;"

      - name: Build
        run: go build -o pgdump-offline.exe .

      - name: Test auto-detection
        shell: pwsh
        run: |
          Write-Host "=== Testing -detect ==="
          .\pgdump-offline.exe -detect
          
          Write-Host "=== Testing -list-db ==="
          .\pgdump-offline.exe -list-db
          
          Write-Host "=== Testing dump ==="
          .\pgdump-offline.exe -db testdb -t users

  build:
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-linux, integration-macos, integration-windows]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build all platforms
        run: |
          mkdir -p dist
          GOOS=linux GOARCH=amd64 go build -o dist/pgdump-offline-linux-amd64 .
          GOOS=darwin GOARCH=amd64 go build -o dist/pgdump-offline-darwin-amd64 .
          GOOS=darwin GOARCH=arm64 go build -o dist/pgdump-offline-darwin-arm64 .
          GOOS=windows GOARCH=amd64 go build -o dist/pgdump-offline-windows-amd64.exe .

      - uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: dist/
