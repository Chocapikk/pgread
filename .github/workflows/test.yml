name: Test

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - run: go test -v ./... -run "TestDecode|TestParseJSONB"

  # Linux integration tests with Docker
  integration-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pg: ['12', '13', '14', '15', '16', '17']
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build binary
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o pgdump-offline .

      - name: Start PostgreSQL ${{ matrix.pg }}
        run: |
          docker run -d --name pg \
            -e POSTGRES_PASSWORD=testpass \
            -e POSTGRES_DB=testdb \
            postgres:${{ matrix.pg }}
          
          # Wait for PostgreSQL to be ready
          for i in {1..30}; do
            docker exec pg pg_isready -U postgres && break
            sleep 1
          done

      - name: Create test data
        run: |
          docker exec pg psql -U postgres -d testdb << 'EOF'
          CREATE TABLE users (
            id SERIAL PRIMARY KEY,
            email VARCHAR(255),
            password_hash VARCHAR(255),
            is_admin BOOLEAN DEFAULT false,
            created_at TIMESTAMP DEFAULT NOW()
          );
          INSERT INTO users (email, password_hash, is_admin) VALUES
            ('admin@test.com', '$argon2id$v=19$m=4096,t=3,p=1$salt$hash', true),
            ('user1@test.com', '$argon2id$v=19$m=4096,t=3,p=1$salt$hash2', false),
            ('user2@test.com', '$argon2id$v=19$m=4096,t=3,p=1$salt$hash3', false);
          
          CREATE TABLE secrets (
            id SERIAL PRIMARY KEY,
            name VARCHAR(255) UNIQUE,
            value JSONB NOT NULL,
            created_at TIMESTAMP DEFAULT NOW()
          );
          INSERT INTO secrets (name, value) VALUES
            ('aws_credentials', '{"access_key": "AKIAIOSFODNN7EXAMPLE", "secret_key": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"}'),
            ('database_url', '{"host": "db.internal", "port": 5432, "password": "supersecret123"}'),
            ('api_keys', '{"stripe": "sk_live_xxx", "github": "ghp_xxxx"}');
          
          CREATE TABLE tokens (
            id SERIAL PRIMARY KEY,
            user_id INTEGER REFERENCES users(id),
            token VARCHAR(255),
            expires_at TIMESTAMPTZ
          );
          INSERT INTO tokens (user_id, token, expires_at) VALUES
            (1, 'admin_token_abc123', NOW() + INTERVAL '1 day'),
            (2, 'user_token_def456', NOW() + INTERVAL '1 hour');
          
          CHECKPOINT;
          EOF
          
          # Wait for data to be flushed to disk
          sleep 5
          docker exec pg sync

      - name: Copy binary to container
        run: docker cp pgdump-offline pg:/usr/local/bin/

      - name: Debug PostgreSQL
        run: |
          echo "=== PostgreSQL data directory ==="
          docker exec pg ls -la /var/lib/postgresql/data/
          docker exec pg ls -la /var/lib/postgresql/data/global/ | head -10
          docker exec pg ls -la /var/lib/postgresql/data/base/
          
          echo "=== PostgreSQL version ==="
          docker exec pg psql -U postgres -c "SELECT version();"
          
          echo "=== Databases ==="
          docker exec pg psql -U postgres -c "SELECT oid, datname FROM pg_database;"

      - name: Test pg_database parsing
        run: |
          echo "=== Testing pg_database ==="
          docker exec pg pgdump-offline -f /var/lib/postgresql/data/global/1262
          
          echo "=== List databases ==="
          docker exec pg pgdump-offline -d /var/lib/postgresql/data/ -list-db

      - name: Test full dump
        run: |
          echo "=== Testing full dump ==="
          docker exec pg pgdump-offline -d /var/lib/postgresql/data/ -db testdb -v 2>&1 | tee dump.json
          
          # Verify output
          cat dump.json | jq -e '.databases[0].name == "testdb"'
          cat dump.json | jq -e '.databases[0].tables | length > 0'

      - name: Test table filtering
        run: |
          echo "=== Testing secrets table ==="
          docker exec pg pgdump-offline -d /var/lib/postgresql/data/ -db testdb -t secrets | tee secrets.json
          
          # Verify JSONB parsing
          cat secrets.json | jq -e '.databases[0].tables[0].rows[0].value.access_key'

      - name: Test users table
        run: |
          echo "=== Testing users table ==="
          docker exec pg pgdump-offline -d /var/lib/postgresql/data/ -db testdb -t users | tee users.json
          
          # Verify data
          cat users.json | jq -e '.databases[0].tables[0].rows | length == 3'
          cat users.json | jq -r '.databases[0].tables[0].rows[0].password_hash' | grep -q 'argon2'

      - name: Cleanup
        if: always()
        run: docker rm -f pg || true

  # macOS integration test
  integration-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install PostgreSQL
        run: |
          brew install postgresql@16
          brew services start postgresql@16
          sleep 5
          
          # Create test database
          /opt/homebrew/opt/postgresql@16/bin/createdb -h localhost testdb || \
          /usr/local/opt/postgresql@16/bin/createdb -h localhost testdb

      - name: Create test data
        run: |
          PSQL=$(/opt/homebrew/opt/postgresql@16/bin/psql 2>/dev/null && echo /opt/homebrew/opt/postgresql@16/bin/psql || echo /usr/local/opt/postgresql@16/bin/psql)
          $PSQL -h localhost -d testdb << 'EOF'
          CREATE TABLE users (id SERIAL, email VARCHAR(255), password_hash VARCHAR(255));
          INSERT INTO users (email, password_hash) VALUES ('admin@test.com', '$argon2id$hash');
          CREATE TABLE secrets (id SERIAL, name VARCHAR(255), value JSONB);
          INSERT INTO secrets (name, value) VALUES ('aws', '{"key": "AKIA..."}');
          CHECKPOINT;
          EOF

      - name: Build
        run: go build -o pgdump-offline .

      - name: Test auto-detection
        run: |
          echo "=== Testing -detect ==="
          ./pgdump-offline -detect
          
          echo "=== Testing -list-db ==="
          ./pgdump-offline -list-db
          
          echo "=== Testing auto-detect dump ==="
          ./pgdump-offline -db testdb -t users | jq .

  # Windows integration test  
  integration-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install PostgreSQL
        shell: pwsh
        run: |
          choco install postgresql16 --params '/Password:testpass' -y
          refreshenv
          
          # Wait for service
          Start-Sleep -Seconds 10
          
          # Add to PATH
          $env:PATH = "C:\Program Files\PostgreSQL\16\bin;$env:PATH"
          [Environment]::SetEnvironmentVariable("PATH", $env:PATH, "Process")

      - name: Create test data
        shell: pwsh
        run: |
          $env:PGPASSWORD = "testpass"
          $env:PATH = "C:\Program Files\PostgreSQL\16\bin;$env:PATH"
          
          & psql -U postgres -c "CREATE DATABASE testdb;"
          & psql -U postgres -d testdb -c "CREATE TABLE users (id SERIAL, email VARCHAR(255), password_hash VARCHAR(255));"
          & psql -U postgres -d testdb -c "INSERT INTO users (email, password_hash) VALUES ('admin@test.com', '\$argon2id\$hash');"
          & psql -U postgres -d testdb -c "CREATE TABLE secrets (id SERIAL, name VARCHAR(255), value JSONB);"
          & psql -U postgres -d testdb -c "INSERT INTO secrets (name, value) VALUES ('aws', '{\"key\": \"AKIA...\"}');"
          & psql -U postgres -d testdb -c "CHECKPOINT;"

      - name: Build
        run: go build -o pgdump-offline.exe .

      - name: Test auto-detection
        shell: pwsh
        run: |
          Write-Host "=== Testing -detect ==="
          .\pgdump-offline.exe -detect
          
          Write-Host "=== Testing -list-db ==="
          .\pgdump-offline.exe -list-db
          
          Write-Host "=== Testing dump ==="
          .\pgdump-offline.exe -db testdb -t users

  build:
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-linux, integration-macos, integration-windows]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build all platforms
        run: |
          mkdir -p dist
          GOOS=linux GOARCH=amd64 go build -o dist/pgdump-offline-linux-amd64 .
          GOOS=darwin GOARCH=amd64 go build -o dist/pgdump-offline-darwin-amd64 .
          GOOS=darwin GOARCH=arm64 go build -o dist/pgdump-offline-darwin-arm64 .
          GOOS=windows GOARCH=amd64 go build -o dist/pgdump-offline-windows-amd64.exe .

      - uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: dist/
